<?php
class Admin_hilight extends Admin_Controller
{
    public function __construct()
    {
        parent::__construct();
        $this->load->model('admin_hilight/hilight_model','hilight');
    }
    public $menu_id = 41;
    function index()
    {
        $data['hilights'] = $this->hilight->order_by('show_no','desc')->get();
        $data['pagination'] = $this->hilight->pagination();
		$data['max_no'] = $this->db->getone("SELECT MAX(show_no) FROM hilight ");
		$data['min_no'] = $this->db->getone("SELECT MIN(show_no) FROM hilight ");
		$data['menu_id'] = $this->menu_id;
        $this->template->build('index',$data);
    }
    
    function form($id=false){
        $data['hilight'] = $this->hilight->get_row($id);
        $this->template->build('form',$data);
    }
    
    function save($id=false){
        if($_POST){
        	$menu_id=$this->menu_id;
			$menu_name = get_menu_name($menu_id);
			$_POST['user_id'] = login_data('id');
			if($_POST['id']!='')
			{
				if(permission($menu_id, 'canedit')=='')redirect('admin_hilight');
				$action='Update';
				$description = $action.' '.$menu_name;		
				save_log($menu_id,$action,$description);
			}else{
				if(permission($menu_id, 'canadd')=='')redirect('admin_hilight');	
				$action='Add';
				$_POST['create_date'] = date("Y-m-d H:i:s");
				$description = $action.' '.$menu_name;	
				$_POST['show_no'] = $this->db->getone("SELECT (max(show_no)+1) from hilight");
				save_log($menu_id,$action,$description);
			}	
            $this->hilight->save($_POST);
            set_notify('success', SAVE_DATA_COMPLATE);
        }
        redirect('admin_hilight');
    }
    
    function delete($id){
        if($id){
            $this->hilight->delete($id);
            set_notify('success', SAVE_DATA_COMPLATE);
        }
        redirect('admin_hilight');
    }
	
	public function ordering($mode=FALSE,$current_id=FALSE,$step=1,$redirect=TRUE){
		    //$this->db->debug = true;
		    $table_name = "hilight";
			$condition=  "1=1";
			$mode = @$_GET['mode']!='' ? $_GET['mode'] : $mode; 
			$current_id = @$_GET['id'] > 0 ? $_GET['id'] : $current_id;
			
			
			switch($mode){
				case 'top':
						$current_data = $this->db->getrow("SELECT * FROM ".$table_name." where id=".$current_id);
						$update_record['id']=$current_data['id'];
						$update_record['show_no'] = $this->db->getone("SELECT (max(show_no)+1) from ".$table_name);
						//$this->banner->save($update_record);
						$this->db->execute("UPDATE ".$table_name."  SET show_no=".$update_record['show_no']." where id=".$update_record['id']);
					break;
				case 'bottom':
						$current_data = $this->db->getrow("SELECT * FROM ".$table_name." where id=".$current_id);
						$this->db->execute("UPDATE ".$table_name." SET show_no=show_no+1 where id <> ".$current_id);
						$this->db->execute("UPDATE ".$table_name."  SET show_no=1 where id=".$current_id);
					break;
				case 'up':					
					for($i=1;$i<=$step;$i++):
						$current_data = $this->db->getrow("SELECT * FROM ".$table_name."  where id=".$current_id);
						$sql= " SELECT * FROM ".$table_name."  WHERE ".$condition." AND show_no > ".$current_data['show_no']." ORDER BY show_no LIMIT 0,1 ";
						$up_rec = $this->db->getrow($sql);
						if(@$up_rec['id']>0){
						$update_record['id'] = $up_rec['id'];
						$update_record['show_no'] = $current_data['show_no'];					
						//$this->banner->save($update_record);
						$this->db->execute("UPDATE ".$table_name."  SET show_no=".$update_record['show_no']." where id=".$update_record['id']);
					
						
						$update_record['id'] = $current_data['id'];
						$update_record['show_no'] = $up_rec['show_no'];
						//$this->banner->save($update_record);
						$this->db->execute("UPDATE ".$table_name."  SET show_no=".$update_record['show_no']." where id=".$update_record['id']);
						}
					endfor;
					break;
				case 'down':
					for($i=1;$i<=$step;$i++):
					$current_data = $this->db->getrow("SELECT * FROM ".$table_name."  where id=".$current_id);
					$sql= " SELECT * FROM ".$table_name."  WHERE ".$condition." AND show_no < ".$current_data['show_no']." ORDER BY show_no DESC LIMIT 0,1 ";
					$up_rec = $this->db->getrow($sql);
						if(@$up_rec['id']>0){
						$update_record['id'] = $up_rec['id'];
						$update_record['show_no'] = $current_data['show_no'];					
						//$this->banner->save($update_record);
						$this->db->execute("UPDATE ".$table_name."  SET show_no=".$update_record['show_no']." where id=".$update_record['id']);
						
						$update_record['id'] = $current_data['id'];
						$update_record['show_no'] = $up_rec['show_no'];
						//$this->banner->save($update_record);
						$this->db->execute("UPDATE ".$table_name."  SET show_no=".$update_record['show_no']." where id=".$update_record['id']);
						}
					endfor;
					break;
			}
			if($redirect==TRUE)
			{
				redirect('admin_hilight?page='.@$_GET['page']);
			}
	}
}
?>